@model List<Colibri.WebApi.Models.UserModel>
@{
    ViewData["Title"] = "Управление пользователями";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="container user-management-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Управление пользователями</h1>
        <div>
            <button class="btn btn-primary" onclick="showAddUserModal()">
                + Добавить пользователя
            </button>
        </div>
    </div>

    <!-- Статистика -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-value">@Model.Count</div>
            <div class="stat-label">Всего пользователей</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">@Model.Count(u => u.Roles.Contains("Admin"))</div>
            <div class="stat-label">Администраторов</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">@Model.Count(u => u.IsLockedOut)</div>
            <div class="stat-label">Заблокировано</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">@Model.Count(u => u.EmailConfirmed)</div>
            <div class="stat-label">Подтвержденных</div>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="filters">
        <button class="filter-btn active" onclick="filterUsers('all')">Все</button>
        <button class="filter-btn" onclick="filterUsers('admins')">Администраторы</button>
        <button class="filter-btn" onclick="filterUsers('locked')">Заблокированные</button>
        <button class="filter-btn" onclick="filterUsers('unconfirmed')">Не подтвержденные</button>
    </div>

    <!-- Поиск -->
    <div class="search-bar">
        <input type="text" 
               class="search-input" 
               placeholder="Поиск по имени, email или роли..." 
               onkeyup="searchUsers(this.value)">
        <button class="search-btn" onclick="searchUsers(document.querySelector('.search-input').value)">
            🔍 Поиск
        </button>
    </div>

    <!-- Таблица пользователей -->
    <div class="table-responsive">
        <table class="user-table">
            <thead>
                <tr>
                    <th>Пользователь</th>
                    <th>Роли</th>
                    <th>Последний вход</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr class="user-row" 
                        data-id="@user.Id"
                        data-name="@user.FullName.ToLower()"
                        data-email="@user.Email.ToLower()"
                        data-roles="@string.Join(" ", user.Roles).ToLower()"
                        data-status="@(user.IsLockedOut ? "locked" : "active")"
                        data-confirmed="@user.EmailConfirmed.ToString().ToLower()">
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    @GetInitials(user.FirstName, user.LastName)
                                </div>
                                <div>
                                    <div class="user-name">@user.FullName</div>
                                    <div class="user-email">@user.Email</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="user-roles">
                                @foreach (var role in user.Roles)
                                {
                                    <span class="role-badge @GetRoleClass(role)">@role</span>
                                }
                            </div>
                        </td>
                        <td>
                            @user.FormattedLastLogin
                        </td>
                        <td>
                            @if (user.IsLockedOut)
                            {
                                <span class="user-status status-locked">Заблокирован</span>
                            }
                            else if (!user.EmailConfirmed)
                            {
                                <span class="user-status status-inactive">Не подтвержден</span>
                            }
                            else
                            {
                                <span class="user-status status-active">Активен</span>
                            }
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="/admin/users/details/@user.Id" 
                                   class="action-btn btn-view">👁 Просмотр</a>
                                <button class="action-btn btn-edit" 
                                        onclick="showEditUserModal('@user.Id')">✏️ Редактировать</button>
                                
                                @if (user.IsLockedOut)
                                {
                                    <button class="action-btn btn-unlock" 
                                            onclick="toggleUserLock('@user.Id')">🔓 Разблокировать</button>
                                }
                                else
                                {
                                    <button class="action-btn btn-lock" 
                                            onclick="toggleUserLock('@user.Id')">🔒 Заблокировать</button>
                                }
                                
                                <button class="action-btn btn-reset" 
                                        onclick="showResetPasswordModal('@user.Id', '@user.UserName')">🔄 Сброс пароля</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно добавления пользователя -->
<div class="modal" id="addUserModal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Добавить пользователя</h5>
            <button type="button" class="btn-close" onclick="closeModal('addUserModal')">×</button>
        </div>
        <form id="addUserForm" method="post" action="/admin/users/create">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Имя</label>
                    <input type="text" name="firstName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Фамилия</label>
                    <input type="text" name="lastName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Отчество</label>
                    <input type="text" name="surName" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Email (логин)</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" name="password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Роли</label>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label><input type="checkbox" name="roles" value="Admin"> Администратор</label>
                        <label><input type="checkbox" name="roles" value="User"> Пользователь</label>
                        <label><input type="checkbox" name="roles" value="Technician"> Техник</label>
                        <label><input type="checkbox" name="roles" value="Seller"> Продавец</label>
                        <label><input type="checkbox" name="roles" value="Buyer"> Покупатель</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Отмена</button>
                <button type="submit" class="btn btn-primary">Добавить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно сброса пароля -->
<div class="modal" id="resetPasswordModal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Сброс пароля</h5>
            <button type="button" class="btn-close" onclick="closeModal('resetPasswordModal')">×</button>
        </div>
        <form id="resetPasswordForm">
            <div class="modal-body">
                <p>Сбросить пароль для пользователя: <strong id="resetUserName"></strong></p>
                <div class="form-group">
                    <label class="form-label">Новый пароль</label>
                    <input type="password" id="newPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Подтвердите пароль</label>
                    <input type="password" id="confirmPassword" class="form-control" required>
                </div>
                <input type="hidden" id="resetUserId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="submitResetPassword()">Сбросить пароль</button>
            </div>
        </form>
    </div>
</div>

@functions {
    public string GetInitials(string firstName, string lastName)
    {
        if (string.IsNullOrEmpty(firstName) || string.IsNullOrEmpty(lastName))
            return "??";
        
        return $"{firstName[0]}{lastName[0]}".ToUpper();
    }
    
    public string GetRoleClass(string role)
    {
        return role?.ToLower() switch
        {
            "admin" => "role-admin",
            "user" => "role-user",
            "technician" => "role-technician",
            "seller" => "role-seller",
            "buyer" => "role-buyer",
            _ => "role-user"
        };
    }
}

<script>
    // Фильтрация пользователей
    function filterUsers(filter) {
        // Обновляем активную кнопку фильтра
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Показываем/скрываем строки в зависимости от фильтра
        const rows = document.querySelectorAll('.user-row');
        rows.forEach(row => {
            let show = false;
            
            switch(filter) {
                case 'all':
                    show = true;
                    break;
                case 'admins':
                    show = row.dataset.roles.includes('admin');
                    break;
                case 'locked':
                    show = row.dataset.status === 'locked';
                    break;
                case 'unconfirmed':
                    show = row.dataset.confirmed === 'false';
                    break;
            }
            
            row.style.display = show ? '' : 'none';
        });
    }
    
    // Поиск пользователей
    function searchUsers(query) {
        const searchTerm = query.toLowerCase();
        const rows = document.querySelectorAll('.user-row');
        
        rows.forEach(row => {
            const name = row.dataset.name;
            const email = row.dataset.email;
            const roles = row.dataset.roles;
            
            const matches = name.includes(searchTerm) || 
                           email.includes(searchTerm) || 
                           roles.includes(searchTerm);
            
            row.style.display = matches ? '' : 'none';
        });
    }
    
    // Модальные окна
    function showAddUserModal() {
        document.getElementById('addUserModal').style.display = 'flex';
    }
    
    function showResetPasswordModal(userId, userName) {
        document.getElementById('resetUserName').textContent = userName;
        document.getElementById('resetUserId').value = userId;
        document.getElementById('resetPasswordModal').style.display = 'flex';
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // Блокировка/разблокировка пользователя
    function toggleUserLock(userId) {
        if (confirm('Вы уверены, что хотите изменить статус блокировки пользователя?')) {
            fetch(`/admin/users/toggle-lock/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Ошибка при изменении статуса блокировки');
                }
            });
        }
    }
    
    // Сброс пароля
    function submitResetPassword() {
        const userId = document.getElementById('resetUserId').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            alert('Пароли не совпадают!');
            return;
        }
        
        if (newPassword.length < 6) {
            alert('Пароль должен содержать минимум 6 символов');
            return;
        }
        
        fetch(`/admin/users/reset-password/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ newPassword: newPassword })
        }).then(response => {
            if (response.ok) {
                alert('Пароль успешно сброшен');
                closeModal('resetPasswordModal');
                location.reload();
            } else {
                alert('Ошибка при сбросе пароля');
            }
        });
    }
    
    // Закрытие модальных окон при клике вне их
    window.onclick = function(event) {
        if (event.target.classList.contains('modal-overlay')) {
            event.target.style.display = 'none';
        }
    }
    
    // Закрытие по ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
        }
    });

       // ========== МОДАЛЬНЫЕ ОКНА ==========
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // Блокируем скролл
        }
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = ''; // Разблокируем скролл
        }
    }
    
    // Закрытие при клике вне модального окна
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('show');
            document.body.style.overflow = '';
        }
    });
    
    // Закрытие при нажатии ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            document.querySelectorAll('.modal.show').forEach(modal => {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            });
        }
    });
    
    // Предотвращаем закрытие при клике внутри модального окна
    document.querySelectorAll('.modal-content').forEach(content => {
        content.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });
    
    // ========== ПОЛЬЗОВАТЕЛЬСКИЕ ФУНКЦИИ ==========
    function showAddUserModal() {
        showModal('addUserModal');
    }
    
    function showResetPasswordModal(userId, userName) {
        document.getElementById('resetUserName').textContent = userName;
        document.getElementById('resetUserId').value = userId;
        showModal('resetPasswordModal');
    }
    
    // ========== ФИЛЬТРАЦИЯ И ПОИСК ==========
    function filterUsers(filter) {
        // Обновляем активную кнопку фильтра
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const rows = document.querySelectorAll('.user-row');
        rows.forEach(row => {
            let show = false;
            
            switch(filter) {
                case 'all':
                    show = true;
                    break;
                case 'admins':
                    show = row.dataset.roles.includes('admin');
                    break;
                case 'locked':
                    show = row.dataset.status === 'locked';
                    break;
                case 'unconfirmed':
                    show = row.dataset.confirmed === 'false';
                    break;
            }
            
            row.style.display = show ? '' : 'none';
        });
    }
    
    function searchUsers(query) {
        const searchTerm = query.toLowerCase();
        const rows = document.querySelectorAll('.user-row');
        
        rows.forEach(row => {
            const matches = row.dataset.name.includes(searchTerm) || 
                           row.dataset.email.includes(searchTerm) || 
                           row.dataset.roles.includes(searchTerm);
            
            row.style.display = matches ? '' : 'none';
        });
    }
    
    // ========== ОПЕРАЦИИ С ПОЛЬЗОВАТЕЛЯМИ ==========
    function toggleUserLock(userId) {
        if (confirm('Вы уверены, что хотите изменить статус блокировки пользователя?')) {
            fetch(`/admin/users/toggle-lock/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Ошибка при изменении статуса блокировки');
                }
            });
        }
    }
    
    function submitResetPassword() {
        const userId = document.getElementById('resetUserId').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            alert('Пароли не совпадают!');
            return;
        }
        
        if (newPassword.length < 6) {
            alert('Пароль должен содержать минимум 6 символов');
            return;
        }
        
        fetch(`/admin/users/reset-password/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ newPassword: newPassword })
        }).then(response => {
            if (response.ok) {
                alert('Пароль успешно сброшен');
                closeModal('resetPasswordModal');
                location.reload();
            } else {
                alert('Ошибка при сбросе пароля');
            }
        });
    }
</script>