@model Colibri.WebApi.Models.UserModel
@{
    ViewData["Title"] = "Детали пользователя";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="user-details-container">
    <!-- Заголовок с информацией о пользователе -->
    <div class="user-header">
        <div class="user-avatar-large">
            @GetInitials(Model.FirstName, Model.LastName)
        </div>
        <div class="user-header-info">
            <div class="user-name-large">@Model.FullName</div>
            <div class="user-email-large">@Model.Email</div>
            <div class="user-roles-large">
                @foreach (var role in Model.Roles)
                {
                    <span class="role-badge-large @GetRoleClass(role)">@role</span>
                }
            </div>
        </div>
        <div class="user-actions">
            <a href="/admin/users" class="btn btn-outline-secondary">← Назад</a>
            <button class="btn btn-primary" onclick="showEditModal()">✏️ Редактировать</button>
            <button class="btn btn-warning" onclick="showResetPasswordModal()">🔄 Сбросить пароль</button>
        </div>
    </div>

    <!-- Карточки с информацией -->
    <div class="info-cards">
        <!-- Основная информация -->
        <div class="info-card">
            <div class="card-title">Основная информация</div>
            <div class="info-grid">
                <div class="info-label">ID:</div>
                <div class="info-value"><code>@Model.Id</code></div>
                
                <div class="info-label">Логин:</div>
                <div class="info-value">@Model.UserName</div>
                
                <div class="info-label">ФИО:</div>
                <div class="info-value">@Model.FullName</div>
                
                <div class="info-label">Email:</div>
                <div class="info-value">@Model.Email</div>
                
                <div class="info-label">Последний вход:</div>
                <div class="info-value">@Model.FormattedLastLogin</div>
            </div>
        </div>

        <!-- Статус и активность -->
        <div class="info-card">
            <div class="card-title">Статус и активность</div>
            <div class="info-grid">
                <div class="info-label">Статус:</div>
                <div class="info-value">
                    @if (Model.IsLockedOut)
                    {
                        <span class="status-indicator status-inactive"></span>
                        <span class="text-danger">Заблокирован</span>
                    }
                    else if (!Model.EmailConfirmed)
                    {
                        <span class="status-indicator status-warning"></span>
                        <span class="text-warning">Не подтвержден</span>
                    }
                    else
                    {
                        <span class="status-indicator status-active"></span>
                        <span class="text-success">Активен</span>
                    }
                </div>
                
                <div class="info-label">Подтвержден:</div>
                <div class="info-value">
                    @if (Model.EmailConfirmed)
                    {
                        <span class="text-success">✓ Email подтвержден</span>
                    }
                    else
                    {
                        <span class="text-warning">✗ Email не подтвержден</span>
                    }
                </div>
                
                <div class="info-label">2FA:</div>
                <div class="info-value">
                    @if (Model.TwoFactorEnabled)
                    {
                        <span class="text-success">✓ Включена</span>
                    }
                    else
                    {
                        <span class="text-secondary">✗ Выключена</span>
                    }
                </div>
                
                <div class="info-label">Телефон:</div>
                <div class="info-value">
                    @if (Model.PhoneNumberConfirmed)
                    {
                        <span class="text-success">✓ Подтвержден</span>
                    }
                    else
                    {
                        <span class="text-secondary">✗ Не подтвержден</span>
                    }
                </div>
                
                <div class="info-label">Неудачные входы:</div>
                <div class="info-value">
                    @Model.AccessFailedCount
                    @if (Model.AccessFailedCount > 0)
                    {
                        <span class="text-warning"> (риск блокировки)</span>
                    }
                </div>
            </div>
        </div>

        <!-- Роли и права -->
        <div class="info-card">
            <div class="card-title">Роли и права</div>
            <div class="info-grid">
                <div class="info-label">Роли:</div>
                <div class="info-value">
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        @foreach (var role in Model.Roles)
                        {
                            <span class="badge @GetRoleClass(role)">@role</span>
                        }
                    </div>
                </div>
                
                <div class="info-label">Всего ролей:</div>
                <div class="info-value">@Model.Roles.Count</div>
                
                <div class="info-label">Управление ролями:</div>
                <div class="info-value">
                    <button class="btn btn-sm btn-outline-primary" onclick="showRoleManagementModal()">
                        Изменить роли
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Журнал активности -->
    <div class="activity-log">
        <div class="card-title">Последние действия</div>
        <table class="activity-table">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Действие</th>
                    <th>IP адрес</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@Model.FormattedLastLogin</td>
                    <td>Последний вход в систему</td>
                    <td>192.168.1.1</td>
                    <td><span class="text-success">Успешно</span></td>
                </tr>
                <!-- Примеры активности -->
                <tr>
                    <td>@DateTime.Now.AddHours(-2).ToString("dd.MM.yyyy HH:mm")</td>
                    <td>Изменение профиля</td>
                    <td>192.168.1.100</td>
                    <td><span class="text-success">Успешно</span></td>
                </tr>
                <tr>
                    <td>@DateTime.Now.AddDays(-1).ToString("dd.MM.yyyy HH:mm")</td>
                    <td>Попытка входа</td>
                    <td>10.0.0.15</td>
                    <td><span class="text-danger">Неудачно</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Настройки безопасности -->
    <div class="security-settings">
        <div class="card-title">Настройки безопасности</div>
        <div class="settings-grid">
            <div class="setting-item">
                <span class="setting-label">Блокировка аккаунта</span>
                <label class="toggle-switch">
                    <input type="checkbox" @(Model.LockoutEnabled ? "checked" : "") 
                           onchange="toggleLockout('@Model.Id', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <span class="setting-label">Двухфакторная аутентификация</span>
                <label class="toggle-switch">
                    <input type="checkbox" @(Model.TwoFactorEnabled ? "checked" : "") 
                           onchange="toggleTwoFactor('@Model.Id', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <span class="setting-label">Подтверждение email</span>
                <label class="toggle-switch">
                    <input type="checkbox" @(Model.EmailConfirmed ? "checked" : "") disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <span class="setting-label">Подтверждение телефона</span>
                <label class="toggle-switch">
                    <input type="checkbox" @(Model.PhoneNumberConfirmed ? "checked" : "") disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Опасная зона -->
    <div class="danger-zone">
        <div class="danger-zone-title">Опасная зона</div>
        <p class="text-muted">Эти действия нельзя отменить. Будьте осторожны.</p>
        <div class="danger-actions">
            <button class="btn btn-danger" onclick="showDeleteModal()">
                🗑 Удалить пользователя
            </button>
            <button class="btn btn-warning" onclick="forceLogout('@Model.Id')">
                🚪 Принудительный выход
            </button>
            <button class="btn btn-outline-danger" onclick="clearFailedLogins('@Model.Id')">
                🔄 Сбросить неудачные попытки
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Редактировать пользователя</h3>
            <button class="btn-close" onclick="closeModal('editModal')">✕</button>
        </div>
        <form id="editForm" method="post" action="/admin/users/update/@Model.Id">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Имя</label>
                    <input type="text" name="firstName" class="form-control" value="@Model.FirstName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Фамилия</label>
                    <input type="text" name="lastName" class="form-control" value="@Model.LastName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Отчество</label>
                    <input type="text" name="surName" class="form-control" value="@Model.SurName">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-control" value="@Model.Email" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно управления ролями -->
<div class="modal-overlay" id="rolesModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Управление ролями</h3>
            <button class="btn-close" onclick="closeModal('rolesModal')">✕</button>
        </div>
        <div class="modal-body">
            <p>Текущие роли пользователя <strong>@Model.UserName</strong>:</p>
            <div id="currentRoles" style="margin-bottom: 15px;">
                @foreach (var role in Model.Roles)
                {
                    <span class="badge @GetRoleClass(role)" style="margin: 2px;">@role</span>
                }
            </div>
            
            <div class="form-group">
                <label class="form-label">Добавить роль</label>
                <select id="roleSelect" class="form-control">
                    <option value="">Выберите роль</option>
                    <option value="Admin">Администратор</option>
                    <option value="User">Пользователь</option>
                    <option value="Technician">Техник</option>
                    <option value="Seller">Продавец</option>
                    <option value="Buyer">Покупатель</option>
                </select>
                <button class="btn btn-sm btn-primary mt-2" onclick="addRole()">Добавить</button>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('rolesModal')">Закрыть</button>
        </div>
    </div>
</div>

<!-- Модальное окно сброса пароля -->
<div class="modal-overlay" id="resetModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Сброс пароля</h3>
            <button class="btn-close" onclick="closeModal('resetModal')">✕</button>
        </div>
        <div class="modal-body">
            <p>Сбросить пароль для пользователя: <strong>@Model.UserName</strong></p>
            <div class="form-group">
                <label class="form-label">Новый пароль</label>
                <input type="password" id="newPassword" class="form-control" placeholder="Минимум 6 символов">
            </div>
            <div class="form-group">
                <label class="form-label">Подтвердите пароль</label>
                <input type="password" id="confirmPassword" class="form-control">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('resetModal')">Отмена</button>
            <button type="button" class="btn btn-primary" onclick="resetPassword()">Сбросить</button>
        </div>
    </div>
</div>

@functions {
    public string GetInitials(string firstName, string lastName)
    {
        if (string.IsNullOrEmpty(firstName) || string.IsNullOrEmpty(lastName))
            return "??";
        
        return $"{firstName[0]}{lastName[0]}".ToUpper();
    }
    
    public string GetRoleClass(string role)
    {
        return role?.ToLower() switch
        {
            "admin" => "badge-danger",
            "user" => "badge-success",
            "technician" => "badge-info",
            "seller" => "badge-warning",
            "buyer" => "badge-primary",
            _ => "badge-secondary"
        };
    }
}

<script>
    // Модальные окна
    function showEditModal() {
        document.getElementById('editModal').style.display = 'flex';
    }
    
    function showRoleManagementModal() {
        document.getElementById('rolesModal').style.display = 'flex';
    }
    
    function showResetPasswordModal() {
        document.getElementById('resetModal').style.display = 'flex';
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // Тогглы
    function toggleLockout(userId, enabled) {
        fetch(`/admin/users/toggle-lock/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ enabled: enabled })
        }).then(response => {
            if (!response.ok) {
                alert('Ошибка при изменении статуса блокировки');
            }
        });
    }
    
    function toggleTwoFactor(userId, enabled) {
        fetch(`/admin/users/toggle-twofactor/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ enabled: enabled })
        }).then(response => {
            if (!response.ok) {
                alert('Ошибка при изменении настроек 2FA');
            }
        });
    }
    
    // Управление ролями
    function addRole() {
        const roleSelect = document.getElementById('roleSelect');
        const role = roleSelect.value;
        
        if (!role) {
            alert('Выберите роль');
            return;
        }
        
        fetch(`/admin/users/add-role/@Model.Id`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ role: role })
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Ошибка при добавлении роли');
            }
        });
    }
    
    function removeRole(role) {
        if (confirm(`Удалить роль "${role}"?`)) {
            fetch(`/admin/users/remove-role/@Model.Id`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ role: role })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Ошибка при удалении роли');
                }
            });
        }
    }
    
    // Сброс пароля
    function resetPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            alert('Пароли не совпадают!');
            return;
        }
        
        if (newPassword.length < 6) {
            alert('Пароль должен содержать минимум 6 символов');
            return;
        }
        
        fetch(`/admin/users/reset-password/@Model.Id`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ newPassword: newPassword })
        }).then(response => {
            if (response.ok) {
                alert('Пароль успешно сброшен');
                closeModal('resetModal');
            } else {
                alert('Ошибка при сбросе пароля');
            }
        });
    }
    
    // Опасные действия
    function showDeleteModal() {
        if (confirm('Вы уверены, что хотите удалить этого пользователя? Это действие нельзя отменить.')) {
            fetch(`/admin/users/delete/@Model.Id`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    window.location.href = '/admin/users';
                } else {
                    alert('Ошибка при удалении пользователя');
                }
            });
        }
    }
    
    function forceLogout(userId) {
        if (confirm('Принудительно выйти из всех сессий пользователя?')) {
            fetch(`/admin/users/force-logout/${userId}`, {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    alert('Пользователь выброшен из системы');
                } else {
                    alert('Ошибка при выходе пользователя');
                }
            });
        }
    }
    
    function clearFailedLogins(userId) {
        fetch(`/admin/users/clear-failed-logins/${userId}`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                alert('Счетчик неудачных попыток сброшен');
                location.reload();
            } else {
                alert('Ошибка при сбросе счетчика');
            }
        });
    }
    
    // Закрытие модальных окон
    window.onclick = function(event) {
        if (event.target.classList.contains('modal-overlay')) {
            event.target.style.display = 'none';
        }
    }
    
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
        }
    });
</script>