@model Colibri.WebApi.Models.UserModel
@{
    ViewData["Title"] = $"Пользователь: {Model.UserName}";
}

<div class="user-details-container">
    <!-- Заголовок -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>@ViewData["Title"]</h1>
        <div>
            <a href="/account" class="btn btn-outline-secondary">
                ← Назад к списку
            </a>
        </div>
    </div>

    <!-- Основная информация -->
    <div class="user-header card mb-4">
        <div class="card-body">
            <div class="user-info">
                <div class="user-avatar-large">
                    @{
                        var avatarText = string.IsNullOrEmpty(Model.FirstName) && string.IsNullOrEmpty(Model.LastName) 
                            ? Model.UserName?[0].ToString().ToUpper() 
                            : (!string.IsNullOrEmpty(Model.FirstName) ? Model.FirstName[0] : Model.LastName?[0]).ToString().ToUpper();
                    }
                    @avatarText
                </div>
                <div>
                    <div class="user-name-large">
                        @(string.IsNullOrEmpty(Model.FirstName) && string.IsNullOrEmpty(Model.LastName) 
                            ? Model.UserName 
                            : $"{Model.FirstName} {Model.LastName}".Trim())
                    </div>
                    <div class="user-email-large mb-2">@Model.Email</div>
                    <div class="user-roles-large">
                        @if (Model.Roles != null && Model.Roles.Any())
                        {
                            foreach (var role in Model.Roles)
                            {
                                <span class="role-badge role-@role.ToLower()">@role</span>
                            }
                        }
                        else
                        {
                            <span class="text-muted">Нет ролей</span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Карточки с информацией -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="info-card card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Основная информация</h5>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-label">Имя:</div>
                        <div class="info-value">@(Model.FirstName ?? "Не указано")</div>
                        
                        <div class="info-label">Фамилия:</div>
                        <div class="info-value">@(Model.LastName ?? "Не указана")</div>
                        
                        @if (!string.IsNullOrEmpty(Model.SurName))
                        {
                            <div class="info-label">Отчество:</div>
                            <div class="info-value">@Model.SurName</div>
                        }
                        
                        <div class="info-label">Email:</div>
                        <div class="info-value">@Model.Email</div>
                        
                        <div class="info-label">Имя пользователя:</div>
                        <div class="info-value">@Model.UserName</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="info-card card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Статус и безопасность</h5>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-label">Статус:</div>
                        <div class="info-value">
                            @if (Model.LockoutEnabled)
                            {
                                <span class="status-badge status-locked">Заблокирован</span>
                            }
                            else if (!Model.EmailConfirmed)
                            {
                                <span class="status-badge status-inactive">Не подтвержден</span>
                            }
                            else
                            {
                                <span class="status-badge status-active">Активен</span>
                            }
                        </div>
                        
                        <div class="info-label">Email подтвержден:</div>
                        <div class="info-value">
                            @if (Model.EmailConfirmed)
                            {
                                <span class="text-success">✓ Да</span>
                            }
                            else
                            {
                                <span class="text-danger">✗ Нет</span>
                            }
                        </div>
                        
                        <div class="info-label">Телефон подтвержден:</div>
                        <div class="info-value">
                            @if (Model.PhoneNumberConfirmed)
                            {
                                <span class="text-success">✓ Да</span>
                            }
                            else
                            {
                                <span class="text-muted">Не указан</span>
                            }
                        </div>
                        
                        <div class="info-label">Двухфакторная аутентификация:</div>
                        <div class="info-value">
                            @if (Model.TwoFactorEnabled)
                            {
                                <span class="text-success">✓ Включена</span>
                            }
                            else
                            {
                                <span class="text-muted">Выключена</span>
                            }
                        </div>
                        
                        <div class="info-label">Последний вход:</div>
                        <div class="info-value">
                            @Model.LastLogin.ToString(format: "dd.MM.yyyy HH:mm")
                        </div>
                        
                        <div class="info-label">Неудачных попыток входа:</div>
                        <div class="info-value">@Model.AccessFailedCount</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Действия -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Действия</h5>
        </div>
        <div class="card-body">
            <div class="action-buttons">
                <button class="btn btn-outline-warning" onclick="userManagement.editUser('@Model.UserName')">
                    ✏ Редактировать
                </button>
                
                @if (Model.LockoutEnabled)
                {
                    <button class="btn btn-outline-success" onclick="userManagement.toggleLock('@Model.UserName')">
                        🔓 Разблокировать
                    </button>
                }
                else
                {
                    <button class="btn btn-outline-danger" onclick="userManagement.toggleLock('@Model.UserName')">
                        🔒 Заблокировать
                    </button>
                }
                
                <button class="btn btn-outline-info" onclick="userManagement.resetPassword('@Model.UserName')">
                    🔑 Сбросить пароль
                </button>
                
                <button class="btn btn-outline-secondary" onclick="userManagement.manageRoles('@Model.UserName')">
                    👥 Управление ролями
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Модуль управления пользователями для страницы деталей
        const userManagement = window.userManagement || (function() {
            let currentUserName = null;
            
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type} show`;
                notification.innerHTML = `
                    ${message}
                    <button onclick="this.parentElement.remove()" 
                            style="margin-left: 10px; background: none; border: none; cursor: pointer; font-size: 18px;">✕</button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('show');
                }
            }
            
            function closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                }
            }
            
            return {
                editUser: function(userName) {
                    showNotification('Редактирование пользователя: ' + userName, 'info');
                },
                
                toggleLock: async function(userName) {
                    if (!confirm('Вы уверены, что хотите изменить статус блокировки пользователя?')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/account/toggle-lock/${userName}`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            showNotification('Статус блокировки изменен', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showNotification('Ошибка изменения статуса блокировки', 'danger');
                        }
                    } catch (error) {
                        showNotification('Ошибка при изменении статуса блокировки', 'danger');
                    }
                },
                
                resetPassword: function(userName) {
                    currentUserName = userName;
                    
                    // Создаем модальное окно для сброса пароля
                    const modalHtml = `
                        <div class="modal show" id="resetPasswordModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Сброс пароля</h5>
                                    <button type="button" class="btn-close" onclick="this.closest('.modal').classList.remove('show')">×</button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <p>Пользователь: <strong>${userName}</strong></p>
                                    </div>
                                    <form id="resetPasswordForm">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Новый пароль *</label>
                                            <input type="password" class="form-control" name="newPassword" required>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label class="form-label">Подтверждение пароля *</label>
                                            <input type="password" class="form-control" name="confirmPassword" required>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').classList.remove('show')">
                                        Отмена
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="userManagement.confirmResetPassword()">
                                        Сбросить
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Добавляем модальное окно в body
                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = modalHtml;
                    document.body.appendChild(modalContainer);
                },
                
                confirmResetPassword: async function() {
                    const form = document.getElementById('resetPasswordForm');
                    const newPassword = form.newPassword.value;
                    const confirmPassword = form.confirmPassword.value;
                    
                    if (!newPassword || !confirmPassword) {
                        showNotification('Заполните все поля', 'warning');
                        return;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        showNotification('Пароли не совпадают', 'warning');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/account/reset-password/${currentUserName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `newPassword=${encodeURIComponent(newPassword)}`
                        });
                        
                        if (response.ok) {
                            showNotification('Пароль успешно сброшен', 'success');
                            
                            // Удаляем модальное окно
                            const modal = document.getElementById('resetPasswordModal');
                            if (modal) {
                                modal.classList.remove('show');
                                setTimeout(() => modal.parentNode.remove(), 300);
                            }
                        } else {
                            showNotification('Ошибка сброса пароля', 'danger');
                        }
                    } catch (error) {
                        showNotification('Ошибка при сбросе пароля', 'danger');
                    }
                },
                
                manageRoles: function(userName) {
                    currentUserName = userName;
                    
                    // Создаем модальное окно для управления ролями
                    const modalHtml = `
                        <div class="modal show" id="rolesModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Управление ролями</h5>
                                    <button type="button" class="btn-close" onclick="this.closest('.modal').classList.remove('show')">×</button>
                                </div>
                                <div class="modal-body">
                                    <div id="userRolesInfo" class="mb-3">
                                        <strong>Пользователь:</strong> ${userName}<br>
                                        <strong>Email:</strong> Загрузка...
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Добавить роль</label>
                                        <select class="form-select" id="roleSelect">
                                            <option value="">Выберите роль</option>
                                            <option value="admin">Администратор</option>
                                            <option value="technician">Техник</option>
                                            <option value="seller">Продавец</option>
                                            <option value="buyer">Покупатель</option>
                                            <option value="user">Пользователь</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="userManagement.addRoleToUser()">
                                        Добавить роль
                                    </button>
                                    <div id="currentRoles" class="mt-3">
                                        <p class="text-muted">Загрузка ролей...</p>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" onclick="this.closest('.modal').classList.remove('show')">
                                        Готово
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Добавляем модальное окно в body
                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = modalHtml;
                    document.body.appendChild(modalContainer);
                    
                    // Загружаем данные пользователя
                    loadUserRoles(userName);
                },
                
                addRoleToUser: async function() {
                    const roleSelect = document.getElementById('roleSelect');
                    const role = roleSelect.value;
                    
                    if (!role) {
                        showNotification('Выберите роль', 'warning');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/account/setroles?userId=${currentUserName}&role=${role}`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            showNotification(`Роль "${role}" добавлена`, 'success');
                            loadUserRoles(currentUserName);
                            roleSelect.value = '';
                        } else {
                            showNotification('Ошибка добавления роли', 'danger');
                        }
                    } catch (error) {
                        showNotification('Ошибка при добавлении роли', 'danger');
                    }
                },
                
                removeRole: async function(role) {
                    if (!confirm(`Удалить роль "${role}"?`)) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/account/canselrole?userId=${currentUserName}&role=${role}`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            showNotification(`Роль "${role}" удалена`, 'success');
                            loadUserRoles(currentUserName);
                        } else {
                            showNotification('Ошибка удаления роли', 'danger');
                        }
                    } catch (error) {
                        showNotification('Ошибка при удалении роли', 'danger');
                    }
                }
            };
            
            async function loadUserRoles(userName) {
                try {
                    const response = await fetch(`/account/user?userId=${encodeURIComponent(userName)}`);
                    if (response.ok) {
                        const user = await response.json();
                        
                        document.getElementById('userRolesInfo').innerHTML = `
                            <strong>Пользователь:</strong> ${user.userName}<br>
                            <strong>Email:</strong> ${user.email}
                        `;
                        
                        if (user.roles && user.roles.length > 0) {
                            const rolesHtml = user.roles.map(role => `
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                    <span class="role-badge role-${role.toLowerCase()}">${role}</span>
                                    <button class="btn btn-sm btn-outline-danger" onclick="userManagement.removeRole('${role}')">
                                        Удалить
                                    </button>
                                </div>
                            `).join('');
                            document.getElementById('currentRoles').innerHTML = rolesHtml;
                        } else {
                            document.getElementById('currentRoles').innerHTML = '<p class="text-muted">Роли не назначены</p>';
                        }
                    }
                } catch (error) {
                    console.error('Ошибка загрузки ролей:', error);
                }
            }
            
            return userManagement;
        })();
    </script>
}